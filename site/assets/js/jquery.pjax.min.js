// jquery.pjax.js
// copyright chris wanstrath
// https://github.com/defunkt/jquery-pjax
(function(a){function b(b,c,d){d=g(c,d);var e=b.currentTarget;if(e.tagName.toUpperCase()!=="A")throw"$.fn.pjax or $.pjax.click requires an anchor element";if(b.which>1||b.metaKey||b.ctrlKey)return;if(location.protocol!==e.protocol||location.host!==e.host)return;if(e.hash&&e.href.replace(e.hash,"")===location.href.replace(location.hash,""))return;var f={url:e.href,container:a(e).attr("data-pjax"),target:e,clickedElement:a(e),fragment:null};a.pjax(a.extend({},f,d)),b.preventDefault()}function d(){return(new Date).getTime()}function e(a){return a.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"")}function f(a){var b=document.createElement("a");return b.href=a,b}function g(b,c){return b&&c?c.container=b:a.isPlainObject(b)?c=b:c={container:b},c.container&&(c.container=h(c.container)),c}function h(b){b=a(b);if(!b.length)throw"no pjax container for "+b.selector;if(b.selector!==""&&b.context===document)return b;if(b.attr("id"))return a("#"+b.attr("id"));throw"cant get selector for pjax container!"}function i(b,c){var d=a();return b.each(function(){a(this).is(c)&&(d=d.add(this)),d=d.add(c,this)}),d}function j(b,c,d){var f={};f.url=e(c.getResponseHeader("X-PJAX-URL")||d.url);var g=a(b);if(g.length===0)return f;f.title=i(g,"title").last().text();if(d.fragment){var h=i(g,d.fragment).first();h.length&&(f.contents=h.contents(),f.title||(f.title=h.attr("title")||h.data("title")))}else/<html/i.test(b)||(f.contents=g);return f.contents&&(f.contents=f.contents.not("title"),f.contents.find("title").remove()),f.title&&(f.title=a.trim(f.title)),f}function k(){this.mapping={},this.forwardStack=[],this.backStack=[]}a.fn.pjax=function(a,c){return this.live("click.pjax",function(d){b(d,a,c)})};var c=a.pjax=function(b){function p(b,c){var d=a.Event(b,{relatedTarget:e});return o.trigger(d,c),!d.isDefaultPrevented()}b=a.extend(!0,{},a.ajaxSettings,c.defaults,b),a.isFunction(b.url)&&(b.url=b.url());var e=b.target;!e&&b.clickedElement&&(e=b.clickedElement[0]);var g=f(b.url).hash,i=b.beforeSend,k=b.complete,m=b.success,n=b.error,o=b.context=h(b.container);b.data||(b.data={}),b.data._pjax=o.selector;var q;b.beforeSend=function(a,d){d.timeout>0&&(q=setTimeout(function(){p("pjax:timeout",[a,b])&&a.abort("timeout")},d.timeout),d.timeout=0),a.setRequestHeader("X-PJAX","true"),a.setRequestHeader("X-PJAX-Container",o.selector);var e;if(i){e=i.apply(this,arguments);if(e===!1)return!1}if(!p("pjax:beforeSend",[a,d]))return!1;b.push&&!b.replace&&(l.push(c.state.id,o.clone(!0,!0).contents()),window.history.pushState(null,"",b.url)),p("pjax:start",[a,b]),p("start.pjax",[a,b]),p("pjax:send",[a,d])},b.complete=function(a,c){q&&clearTimeout(q),k&&k.apply(this,arguments),p("pjax:complete",[a,c,b]),p("pjax:end",[a,b]),p("end.pjax",[a,b])},b.error=function(a,c,d){var e=j("",a,b);n&&n.apply(this,arguments);var f=p("pjax:error",[a,c,d,b]);c!=="abort"&&f&&(window.location=e.url)},b.success=function(e,f,h){var i=j(e,h,b);if(!i.contents){window.location=i.url;return}c.state={id:b.id||d(),url:i.url,title:i.title,container:o.selector,fragment:b.fragment,timeout:b.timeout},(b.push||b.replace)&&window.history.replaceState(c.state,i.title,i.url),i.title&&(document.title=i.title),o.html(i.contents),typeof b.scrollTo=="number"&&a(window).scrollTop(b.scrollTo),(b.replace||b.push)&&window._gaq&&_gaq.push(["_trackPageview"]),g!==""&&(window.location.href=g),m&&m.apply(this,arguments),p("pjax:success",[e,f,h,b])},c.state||(c.state={id:d(),url:window.location.href,title:document.title,container:o.selector,fragment:b.fragment,timeout:b.timeout},window.history.replaceState(c.state,document.title));var r=c.xhr;return r&&r.readyState<4&&(r.onreadystatechange=a.noop,r.abort()),c.options=b,c.xhr=a.ajax(b),a(document).trigger("pjax",[c.xhr,b]),c.xhr};c.reload=function(b,c){var d={url:window.location.href,push:!1,replace:!0,scrollTo:!1};return a.pjax(a.extend(d,g(b,c)))},c.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20},k.prototype.push=function(a,b){this.mapping[a]=b,this.backStack.push(a);while(this.forwardStack.length)delete this.mapping[this.forwardStack.shift()];while(this.backStack.length>c.defaults.maxCacheLength)delete this.mapping[this.backStack.shift()]},k.prototype.get=function(a){return this.mapping[a]},k.prototype.forward=function(a,b){this.mapping[a]=b,this.backStack.push(a),(a=this.forwardStack.pop())&&delete this.mapping[a]},k.prototype.back=function(a,b){this.mapping[a]=b,this.forwardStack.push(a),(a=this.backStack.pop())&&delete this.mapping[a]};var l=new k;c.click=b;var m="state"in window.history,n=location.href;a(window).bind("popstate",function(b){var d=!m&&location.href==n;m=!0;if(d)return;var e=b.state;if(e&&e.container){var f=a(e.container);if(f.length){var g=l.get(e.id);if(c.state){var h=c.state.id<e.id?"forward":"back";l[h](c.state.id,f.clone(!0,!0).contents())}var i=a.Event("pjax:popstate",{state:e,direction:h});f.trigger(i);var j={id:e.id,url:e.url,container:f,push:!1,fragment:e.fragment,timeout:e.timeout,scrollTo:!1};g?(a(document).trigger("pjax",[null,j]),f.trigger("pjax:start",[null,j]),f.trigger("start.pjax",[null,j]),e.title&&(document.title=e.title),f.html(g),c.state=e,f.trigger("pjax:end",[null,j]),f.trigger("end.pjax",[null,j])):a.pjax(j),f[0].offsetHeight}else window.location=location.href}}),a.inArray("state",a.event.props)<0&&a.event.props.push("state"),a.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),a.support.pjax||(a.pjax=function(b){var c=a.isFunction(b.url)?b.url():b.url,d=b.type?b.type.toUpperCase():"GET",e=a("<form>",{method:d==="GET"?"GET":"POST",action:c,style:"display:none"});d!=="GET"&&d!=="POST"&&e.append(a("<input>",{type:"hidden",name:"_method",value:d.toLowerCase()}));var f=b.data;if(typeof f=="string")a.each(f.split("&"),function(b,c){var d=c.split("=");e.append(a("<input>",{type:"hidden",name:d[0],value:d[1]}))});else if(typeof f=="object")for(key in f)e.append(a("<input>",{type:"hidden",name:key,value:f[key]}));a(document.body).append(e),e.submit()},a.pjax.click=a.noop,a.pjax.reload=window.location.reload,a.fn.pjax=function(){return this})})(jQuery);